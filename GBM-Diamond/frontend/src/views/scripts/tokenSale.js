let newTokenContract;
let bytecode =
  "0x60806040523480156200001157600080fd5b5060405162003b0c38038062003b0c8339818101604052810190620000379190620003f4565b33600260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550846000908162000089919062000724565b5083600190816200009b919062000724565b508260089081620000ad919062000724565b5060016007600063d9b67a2660e01b7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916815260200190815260200160002060006101000a81548160ff0219169083151502179055506001600760006301ffc9a760e01b7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916815260200190815260200160002060006101000a81548160ff02191690831515021790555081600960146101000a81548160ff02191690831515021790555081620001b45780600960006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505b50505050506200080b565b6000604051905090565b600080fd5b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6200022882620001dd565b810181811067ffffffffffffffff821117156200024a5762000249620001ee565b5b80604052505050565b60006200025f620001bf565b90506200026d82826200021d565b919050565b600067ffffffffffffffff82111562000290576200028f620001ee565b5b6200029b82620001dd565b9050602081019050919050565b60005b83811015620002c8578082015181840152602081019050620002ab565b60008484015250505050565b6000620002eb620002e58462000272565b62000253565b9050828152602081018484840111156200030a5762000309620001d8565b5b62000317848285620002a8565b509392505050565b600082601f830112620003375762000336620001d3565b5b815162000349848260208601620002d4565b91505092915050565b60008115159050919050565b620003698162000352565b81146200037557600080fd5b50565b60008151905062000389816200035e565b92915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000620003bc826200038f565b9050919050565b620003ce81620003af565b8114620003da57600080fd5b50565b600081519050620003ee81620003c3565b92915050565b600080600080600060a08688031215620004135762000412620001c9565b5b600086015167ffffffffffffffff811115620004345762000433620001ce565b5b62000442888289016200031f565b955050602086015167ffffffffffffffff811115620004665762000465620001ce565b5b62000474888289016200031f565b945050604086015167ffffffffffffffff811115620004985762000497620001ce565b5b620004a6888289016200031f565b9350506060620004b98882890162000378565b9250506080620004cc88828901620003dd565b9150509295509295909350565b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806200052c57607f821691505b602082108103620005425762000541620004e4565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b600060088302620005ac7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff826200056d565b620005b886836200056d565b95508019841693508086168417925050509392505050565b6000819050919050565b6000819050919050565b600062000605620005ff620005f984620005d0565b620005da565b620005d0565b9050919050565b6000819050919050565b6200062183620005e4565b6200063962000630826200060c565b8484546200057a565b825550505050565b600090565b6200065062000641565b6200065d81848462000616565b505050565b5b8181101562000685576200067960008262000646565b60018101905062000663565b5050565b601f821115620006d4576200069e8162000548565b620006a9846200055d565b81016020851015620006b9578190505b620006d1620006c8856200055d565b83018262000662565b50505b505050565b600082821c905092915050565b6000620006f960001984600802620006d9565b1980831691505092915050565b6000620007148383620006e6565b9150826002028217905092915050565b6200072f82620004d9565b67ffffffffffffffff8111156200074b576200074a620001ee565b5b62000757825462000513565b6200076482828562000689565b600060209050601f8311600181146200079c576000841562000787578287015190505b62000793858262000706565b86555062000803565b601f198416620007ac8662000548565b60005b82811015620007d657848901518255600182019150602085019450602081019050620007af565b86831015620007f65784890151620007f2601f891682620006e6565b8355505b6001600288020188555050505b505050505050565b6132f1806200081b6000396000f3fe608060405234801561001057600080fd5b50600436106100f45760003560e01c80638da5cb5b11610097578063d351cfdc11610066578063d351cfdc14610283578063e985e9c51461029f578063ee062589146102cf578063f242432a146102ff576100f4565b80638da5cb5b146101fb57806395d89b4114610219578063a22cb46514610237578063c87b56dd14610253576100f4565b80631b2ef1ca116100d35780631b2ef1ca146101775780632eb2c2d6146101935780634e1273f4146101af578063862440e2146101df576100f4565b8062fdd58e146100f957806301ffc9a71461012957806306fdde0314610159575b600080fd5b610113600480360381019061010e9190611cc1565b61031b565b6040516101209190611d10565b60405180910390f35b610143600480360381019061013e9190611d83565b610376565b6040516101509190611dcb565b60405180910390f35b6101616103ad565b60405161016e9190611e76565b60405180910390f35b610191600480360381019061018c9190611e98565b61043b565b005b6101ad60048036038101906101a89190611f93565b6106e2565b005b6101c960048036038101906101c491906120c5565b610cea565b6040516101d69190612204565b60405180910390f35b6101f960048036038101906101f4919061227c565b610e69565b005b610203610f14565b60405161021091906122eb565b60405180910390f35b610221610f3a565b60405161022e9190611e76565b60405180910390f35b610251600480360381019061024c9190612332565b610fc8565b005b61026d60048036038101906102689190612372565b6110c5565b60405161027a9190611e76565b60405180910390f35b61029d6004803603810190610298919061239f565b611159565b005b6102b960048036038101906102b49190612420565b611557565b6040516102c69190611dcb565b60405180910390f35b6102e960048036038101906102e49190612372565b6115eb565b6040516102f69190611d10565b60405180910390f35b61031960048036038101906103149190612460565b61160f565b005b6000600360008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600083815260200190815260200160002054905092915050565b60008063d9b67a2660e01b837bffffffffffffffffffffffffffffffffffffffffffffffffffffffff191614905080915050919050565b600080546103ba90612529565b80601f01602080910402602001604051908101604052809291908181526020018280546103e690612529565b80156104335780601f1061040857610100808354040283529160200191610433565b820191906000526020600020905b81548152906001019060200180831161041657829003601f168201915b505050505081565b600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461049557600080fd5b80600360003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000848152602001908152602001600020546104f19190612589565b600360003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000848152602001908152602001600020819055503373ffffffffffffffffffffffffffffffffffffffff16600073ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167fc3d58168c5ae7397731d063d5bbf3d657854427343f4c083240f7aacaa2d0f6285856040516105bc9291906125bd565b60405180910390a46105cd33611bd8565b156106a55763f23a6e6160e01b7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19163373ffffffffffffffffffffffffffffffffffffffff1663f23a6e61333386866040518563ffffffff1660e01b8152600401610638949392919061261d565b6020604051808303816000875af1158015610657573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061067b919061268a565b7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916146106a457600080fd5b5b817f6bb7ff708619ba0610cba295a58592e0451dee2622938c8755667688daf3529b60086040516106d69190612750565b60405180910390a25050565b8773ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614806107a25750600460008973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff165b6107e1576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016107d89061280a565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168773ffffffffffffffffffffffffffffffffffffffff1603610850576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016108479061289c565b60405180910390fd5b838390508686905014610898576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161088f9061292e565b60405180910390fd5b60005b86869050811015610b7457600360008a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008888848181106108fa576108f961294e565b5b905060200201358152602001908152602001600020548585838181106109235761092261294e565b5b90506020020135111561096b576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161096290612a15565b60405180910390fd5b84848281811061097e5761097d61294e565b5b90506020020135600360008b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008989858181106109d9576109d861294e565b5b905060200201358152602001908152602001600020546109f99190612a35565b600360008b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000898985818110610a4d57610a4c61294e565b5b90506020020135815260200190815260200160002081905550848482818110610a7957610a7861294e565b5b90506020020135600360008a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000898985818110610ad457610ad361294e565b5b90506020020135815260200190815260200160002054610af49190612589565b600360008a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000898985818110610b4857610b4761294e565b5b905060200201358152602001908152602001600020819055508080610b6c90612a69565b91505061089b565b8773ffffffffffffffffffffffffffffffffffffffff168973ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f4a39dc06d4c0dbc64b70af90fd698a233a518aa5d07e595d983b8c0526c8f7fb8a8a8a8a604051610bee9493929190612b1b565b60405180910390a4610bff88611bd8565b15610cdf5763bc197c8160e01b7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19168873ffffffffffffffffffffffffffffffffffffffff1663bc197c81338c8b8b8b8b8b8b6040518963ffffffff1660e01b8152600401610c72989796959493929190612b92565b6020604051808303816000875af1158015610c91573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610cb5919061268a565b7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff191614610cde57600080fd5b5b505050505050505050565b60606000858590509050600084849050905060008183610d0a9190612c00565b67ffffffffffffffff811115610d2357610d22612c42565b5b604051908082528060200260200182016040528015610d515781602001602082028036833780820191505090505b5090506000805b84821015610e59575b83811015610e4257600360008b8b85818110610d8057610d7f61294e565b5b9050602002016020810190610d959190612c71565b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000898984818110610de457610de361294e565b5b9050602002013581526020019081526020016000205483828685610e089190612c00565b610e129190612589565b81518110610e2357610e2261294e565b5b6020026020010181815250508080610e3a90612a69565b915050610d61565b600090508180610e5190612a69565b925050610d58565b8295505050505050949350505050565b600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610ec357600080fd5b818160089182610ed4929190612e40565b50827f6bb7ff708619ba0610cba295a58592e0451dee2622938c8755667688daf3529b8383604051610f07929190612f3d565b60405180910390a2505050565b600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60018054610f4790612529565b80601f0160208091040260200160405190810160405280929190818152602001828054610f7390612529565b8015610fc05780601f10610f9557610100808354040283529160200191610fc0565b820191906000526020600020905b815481529060010190602001808311610fa357829003601f168201915b505050505081565b80600460003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055508173ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f17307eab39ab6107e8899845ad3d59bd9653f200f220920489ca2b5937696c31836040516110b99190611dcb565b60405180910390a35050565b6060600880546110d490612529565b80601f016020809104026020016040519081016040528092919081815260200182805461110090612529565b801561114d5780601f106111225761010080835404028352916020019161114d565b820191906000526020600020905b81548152906001019060200180831161113057829003601f168201915b50505050509050919050565b600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146111b357600080fd5b60005b848490508110156113e7578282828181106111d4576111d361294e565b5b90506020020135600360003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600087878581811061122f5761122e61294e565b5b9050602002013581526020019081526020016000205461124f9190612589565b600360003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008787858181106112a3576112a261294e565b5b905060200201358152602001908152602001600020819055508484828181106112cf576112ce61294e565b5b905060200201357f6bb7ff708619ba0610cba295a58592e0451dee2622938c8755667688daf3529b60086040516113069190612750565b60405180910390a2600560008686848181106113255761132461294e565b5b90506020020135815260200190815260200160002060009054906101000a900460ff166113d4576001600560008787858181106113655761136461294e565b5b90506020020135815260200190815260200160002060006101000a81548160ff02191690831515021790555060068585838181106113a6576113a561294e565b5b9050602002013590806001815401808255809150506001900390600052602060002001600090919091909150555b80806113df90612a69565b9150506111b6565b503373ffffffffffffffffffffffffffffffffffffffff16600073ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f4a39dc06d4c0dbc64b70af90fd698a233a518aa5d07e595d983b8c0526c8f7fb878787876040516114639493929190612b1b565b60405180910390a461147433611bd8565b156115515763bc197c8160e01b7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19163373ffffffffffffffffffffffffffffffffffffffff1663bc197c81336000888888886040518763ffffffff1660e01b81526004016114e496959493929190612f61565b6020604051808303816000875af1158015611503573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611527919061268a565b7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19161461155057600080fd5b5b50505050565b6000600460008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16905092915050565b600681815481106115fb57600080fd5b906000526020600020016000915090505481565b8573ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614806116cf5750600460008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff165b61170e576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161170590613063565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff160361177d576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611774906130f5565b60405180910390fd5b600360008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600085815260200190815260200160002054831115611810576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611807906131ad565b60405180910390fd5b600960149054906101000a900460ff1661190d57600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168673ffffffffffffffffffffffffffffffffffffffff1614806118cd5750600960009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168673ffffffffffffffffffffffffffffffffffffffff16145b61190c576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016119039061323f565b60405180910390fd5b5b82600360008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000868152602001908152602001600020546119699190612a35565b600360008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008681526020019081526020016000208190555082600360008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600086815260200190815260200160002054611a199190612589565b600360008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000868152602001908152602001600020819055508473ffffffffffffffffffffffffffffffffffffffff168673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167fc3d58168c5ae7397731d063d5bbf3d657854427343f4c083240f7aacaa2d0f628787604051611ae39291906125bd565b60405180910390a4611af485611bd8565b15611bd05763f23a6e6160e01b7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19168573ffffffffffffffffffffffffffffffffffffffff1663f23a6e613389888888886040518763ffffffff1660e01b8152600401611b639695949392919061325f565b6020604051808303816000875af1158015611b82573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611ba6919061268a565b7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff191614611bcf57600080fd5b5b505050505050565b60008060007fc5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a47060001b9050833f9150808214158015611c1a57506000801b8214155b92505050919050565b600080fd5b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000611c5882611c2d565b9050919050565b611c6881611c4d565b8114611c7357600080fd5b50565b600081359050611c8581611c5f565b92915050565b6000819050919050565b611c9e81611c8b565b8114611ca957600080fd5b50565b600081359050611cbb81611c95565b92915050565b60008060408385031215611cd857611cd7611c23565b5b6000611ce685828601611c76565b9250506020611cf785828601611cac565b9150509250929050565b611d0a81611c8b565b82525050565b6000602082019050611d256000830184611d01565b92915050565b60007fffffffff0000000000000000000000000000000000000000000000000000000082169050919050565b611d6081611d2b565b8114611d6b57600080fd5b50565b600081359050611d7d81611d57565b92915050565b600060208284031215611d9957611d98611c23565b5b6000611da784828501611d6e565b91505092915050565b60008115159050919050565b611dc581611db0565b82525050565b6000602082019050611de06000830184611dbc565b92915050565b600081519050919050565b600082825260208201905092915050565b60005b83811015611e20578082015181840152602081019050611e05565b60008484015250505050565b6000601f19601f8301169050919050565b6000611e4882611de6565b611e528185611df1565b9350611e62818560208601611e02565b611e6b81611e2c565b840191505092915050565b60006020820190508181036000830152611e908184611e3d565b905092915050565b60008060408385031215611eaf57611eae611c23565b5b6000611ebd85828601611cac565b9250506020611ece85828601611cac565b9150509250929050565b600080fd5b600080fd5b600080fd5b60008083601f840112611efd57611efc611ed8565b5b8235905067ffffffffffffffff811115611f1a57611f19611edd565b5b602083019150836020820283011115611f3657611f35611ee2565b5b9250929050565b60008083601f840112611f5357611f52611ed8565b5b8235905067ffffffffffffffff811115611f7057611f6f611edd565b5b602083019150836001820283011115611f8c57611f8b611ee2565b5b9250929050565b60008060008060008060008060a0898b031215611fb357611fb2611c23565b5b6000611fc18b828c01611c76565b9850506020611fd28b828c01611c76565b975050604089013567ffffffffffffffff811115611ff357611ff2611c28565b5b611fff8b828c01611ee7565b9650965050606089013567ffffffffffffffff81111561202257612021611c28565b5b61202e8b828c01611ee7565b9450945050608089013567ffffffffffffffff81111561205157612050611c28565b5b61205d8b828c01611f3d565b92509250509295985092959890939650565b60008083601f84011261208557612084611ed8565b5b8235905067ffffffffffffffff8111156120a2576120a1611edd565b5b6020830191508360208202830111156120be576120bd611ee2565b5b9250929050565b600080600080604085870312156120df576120de611c23565b5b600085013567ffffffffffffffff8111156120fd576120fc611c28565b5b6121098782880161206f565b9450945050602085013567ffffffffffffffff81111561212c5761212b611c28565b5b61213887828801611ee7565b925092505092959194509250565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b61217b81611c8b565b82525050565b600061218d8383612172565b60208301905092915050565b6000602082019050919050565b60006121b182612146565b6121bb8185612151565b93506121c683612162565b8060005b838110156121f75781516121de8882612181565b97506121e983612199565b9250506001810190506121ca565b5085935050505092915050565b6000602082019050818103600083015261221e81846121a6565b905092915050565b60008083601f84011261223c5761223b611ed8565b5b8235905067ffffffffffffffff81111561225957612258611edd565b5b60208301915083600182028301111561227557612274611ee2565b5b9250929050565b60008060006040848603121561229557612294611c23565b5b60006122a386828701611cac565b935050602084013567ffffffffffffffff8111156122c4576122c3611c28565b5b6122d086828701612226565b92509250509250925092565b6122e581611c4d565b82525050565b600060208201905061230060008301846122dc565b92915050565b61230f81611db0565b811461231a57600080fd5b50565b60008135905061232c81612306565b92915050565b6000806040838503121561234957612348611c23565b5b600061235785828601611c76565b92505060206123688582860161231d565b9150509250929050565b60006020828403121561238857612387611c23565b5b600061239684828501611cac565b91505092915050565b600080600080604085870312156123b9576123b8611c23565b5b600085013567ffffffffffffffff8111156123d7576123d6611c28565b5b6123e387828801611ee7565b9450945050602085013567ffffffffffffffff81111561240657612405611c28565b5b61241287828801611ee7565b925092505092959194509250565b6000806040838503121561243757612436611c23565b5b600061244585828601611c76565b925050602061245685828601611c76565b9150509250929050565b60008060008060008060a0878903121561247d5761247c611c23565b5b600061248b89828a01611c76565b965050602061249c89828a01611c76565b95505060406124ad89828a01611cac565b94505060606124be89828a01611cac565b935050608087013567ffffffffffffffff8111156124df576124de611c28565b5b6124eb89828a01611f3d565b92509250509295509295509295565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b6000600282049050600182168061254157607f821691505b602082108103612554576125536124fa565b5b50919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b600061259482611c8b565b915061259f83611c8b565b92508282019050808211156125b7576125b661255a565b5b92915050565b60006040820190506125d26000830185611d01565b6125df6020830184611d01565b9392505050565b600082825260208201905092915050565b50565b60006126076000836125e6565b9150612612826125f7565b600082019050919050565b600060a08201905061263260008301876122dc565b61263f60208301866122dc565b61264c6040830185611d01565b6126596060830184611d01565b818103608083015261266a816125fa565b905095945050505050565b60008151905061268481611d57565b92915050565b6000602082840312156126a05761269f611c23565b5b60006126ae84828501612675565b91505092915050565b60008190508160005260206000209050919050565b600081546126d981612529565b6126e38186611df1565b945060018216600081146126fe576001811461271457612747565b60ff198316865281151560200286019350612747565b61271d856126b7565b60005b8381101561273f57815481890152600182019150602081019050612720565b808801955050505b50505092915050565b6000602082019050818103600083015261276a81846126cc565b905092915050565b7f7361666542617463685472616e7366657246726f6d3a206d73672e73656e646560008201527f72206973206e6f7420616c6c6f77656420746f206d616e6970756c617465205f60208201527f66726f6d20746f6b656e73000000000000000000000000000000000000000000604082015250565b60006127f4604b83611df1565b91506127ff82612772565b606082019050919050565b60006020820190508181036000830152612823816127e7565b9050919050565b7f7361666542617463685472616e7366657246726f6d3a2063616e6e6f7420747260008201527f616e7366657220746f2030783000000000000000000000000000000000000000602082015250565b6000612886602d83611df1565b91506128918261282a565b604082019050919050565b600060208201905081810360008301526128b581612879565b9050919050565b7f7361666542617463685472616e7366657246726f6d3a205f69647320616e642060008201527f5f76616c756573206c656e676874206d69736d61746368000000000000000000602082015250565b6000612918603783611df1565b9150612923826128bc565b604082019050919050565b600060208201905081810360008301526129478161290b565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b7f7361666542617463685472616e7366657246726f6d3a2042616c616e6365206f60008201527f66205f66726f6d20697320746f6f206c6f7720746f207472616e73666572205f60208201527f76616c75657320746f6b656e7300000000000000000000000000000000000000604082015250565b60006129ff604d83611df1565b9150612a0a8261297d565b606082019050919050565b60006020820190508181036000830152612a2e816129f2565b9050919050565b6000612a4082611c8b565b9150612a4b83611c8b565b9250828203905081811115612a6357612a6261255a565b5b92915050565b6000612a7482611c8b565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8203612aa657612aa561255a565b5b600182019050919050565b600080fd5b82818337505050565b6000612acb8385612151565b93507f07ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff831115612afe57612afd612ab1565b5b602083029250612b0f838584612ab6565b82840190509392505050565b60006040820190508181036000830152612b36818688612abf565b90508181036020830152612b4b818486612abf565b905095945050505050565b82818337600083830152505050565b6000612b7183856125e6565b9350612b7e838584612b56565b612b8783611e2c565b840190509392505050565b600060a082019050612ba7600083018b6122dc565b612bb4602083018a6122dc565b8181036040830152612bc781888a612abf565b90508181036060830152612bdc818688612abf565b90508181036080830152612bf1818486612b65565b90509998505050505050505050565b6000612c0b82611c8b565b9150612c1683611c8b565b9250828202612c2481611c8b565b91508282048414831517612c3b57612c3a61255a565b5b5092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b600060208284031215612c8757612c86611c23565b5b6000612c9584828501611c76565b91505092915050565b600082905092915050565b60006020601f8301049050919050565b600082821b905092915050565b600060088302612cf67fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82612cb9565b612d008683612cb9565b95508019841693508086168417925050509392505050565b6000819050919050565b6000612d3d612d38612d3384611c8b565b612d18565b611c8b565b9050919050565b6000819050919050565b612d5783612d22565b612d6b612d6382612d44565b848454612cc6565b825550505050565b600090565b612d80612d73565b612d8b818484612d4e565b505050565b5b81811015612daf57612da4600082612d78565b600181019050612d91565b5050565b601f821115612df457612dc5816126b7565b612dce84612ca9565b81016020851015612ddd578190505b612df1612de985612ca9565b830182612d90565b50505b505050565b600082821c905092915050565b6000612e1760001984600802612df9565b1980831691505092915050565b6000612e308383612e06565b9150826002028217905092915050565b612e4a8383612c9e565b67ffffffffffffffff811115612e6357612e62612c42565b5b612e6d8254612529565b612e78828285612db3565b6000601f831160018114612ea75760008415612e95578287013590505b612e9f8582612e24565b865550612f07565b601f198416612eb5866126b7565b60005b82811015612edd57848901358255600182019150602085019450602081019050612eb8565b86831015612efa5784890135612ef6601f891682612e06565b8355505b6001600288020188555050505b50505050505050565b6000612f1c8385611df1565b9350612f29838584612b56565b612f3283611e2c565b840190509392505050565b60006020820190508181036000830152612f58818486612f10565b90509392505050565b600060a082019050612f7660008301896122dc565b612f8360208301886122dc565b8181036040830152612f96818688612abf565b90508181036060830152612fab818486612abf565b90508181036080830152612fbe816125fa565b9050979650505050505050565b7f736166655472616e7366657246726f6d3a206d73672e73656e6465722069732060008201527f6e6f7420616c6c6f77656420746f206d616e6970756c617465205f66726f6d2060208201527f746f6b656e730000000000000000000000000000000000000000000000000000604082015250565b600061304d604683611df1565b915061305882612fcb565b606082019050919050565b6000602082019050818103600083015261307c81613040565b9050919050565b7f736166655472616e7366657246726f6d3a2063616e6e6f74207472616e73666560008201527f7220746f20307830000000000000000000000000000000000000000000000000602082015250565b60006130df602883611df1565b91506130ea82613083565b604082019050919050565b6000602082019050818103600083015261310e816130d2565b9050919050565b7f736166655472616e7366657246726f6d3a2042616c616e6365206f66205f667260008201527f6f6d20697320746f6f206c6f7720746f207472616e73666572205f76616c756560208201527f20746f6b656e7300000000000000000000000000000000000000000000000000604082015250565b6000613197604783611df1565b91506131a282613115565b606082019050919050565b600060208201905081810360008301526131c68161318a565b9050919050565b7f54686f7365204e46542061726520736f756c626f756e6420616e642063616e6e60008201527f6f74206265207472616e73666572726564000000000000000000000000000000602082015250565b6000613229603183611df1565b9150613234826131cd565b604082019050919050565b600060208201905081810360008301526132588161321c565b9050919050565b600060a08201905061327460008301896122dc565b61328160208301886122dc565b61328e6040830187611d01565b61329b6060830186611d01565b81810360808301526132ae818486612b65565b905097965050505050505056fea26469706673582212209bafea62d0b34641e43d59c62c59b888cfbaf3445b45128ab4b8d25cf23bc2eb64736f6c63430008130033";

let newMetadata = {
  name: "",
  symbol: "",
  image: "",
  description: "",
};

let calculatedDistribution = [];

generateSelectDropdown(
  "select-currency",
  ["feth"],
  ["Fake Ether (fETH)"],
  () => {}
);

initPage();

function initPage() {
  document.getElementById("smallest-bundle").value = 3;
  document.getElementById("smallest-bundle-display").value = 10;
  document.getElementById("biggest-bundle").value = 11;
  document.getElementById("biggest-bundle-display").value = 5000;
  document.getElementById("whale-factor").value = 50;
  document.getElementById("whale-factor-display").value = 50;

  
  let displayedMetadata = newMetadata;
  displayedMetadata.symbol = undefined;
  displayedMetadata.name = "";

  document.getElementById("token-metadata").value = JSON.stringify(
    displayedMetadata,
    null,
    "\t"
  );
  document.getElementById("smallest-bundle").onchange = function (event) {
    document.getElementById("smallest-bundle-display").value =
      convertStepToValue(event.target.value);
    if(parseInt(document.getElementById("biggest-bundle").value) < parseInt(event.target.value)){
      document.getElementById("biggest-bundle").value = event.target.value;
      document.getElementById("biggest-bundle-display").value =
        convertStepToValue(event.target.value);
    }
  };
  document.getElementById("biggest-bundle").onchange = function (event) {
    document.getElementById("biggest-bundle-display").value =
      convertStepToValue(event.target.value);

    if(parseInt(document.getElementById("smallest-bundle").value) > parseInt(event.target.value)){
      document.getElementById("smallest-bundle").value = event.target.value;
      document.getElementById("smallest-bundle-display").value =
        convertStepToValue(event.target.value);
    }
  };
  document.getElementById("whale-factor").onchange = function (event) {
    document.getElementById("whale-factor-display").value = event.target.value;
  };

  Array.from(document.getElementsByClassName("metadata-trigger")).forEach(
    (_element) => {
      _element.value = "";
      _element.onchange = generateMetadata;
    }
  );

  document.getElementById("generate-btn").onclick = function (event) {
    let saleNumber = parseInt(document.getElementById("token-for-sale").value);
    let smallest = parseFloat(
      document.getElementById("smallest-bundle-display").value
    );
    let largest = parseFloat(
      document.getElementById("biggest-bundle-display").value
    );
    let whaleFactor = parseFloat(
      document.getElementById("whale-factor-display").value
    );

    let resu = generateDistributionFromNotesAndTokenAmount(saleNumber, smallest, largest, (whaleFactor * 0.01));


    let _ids = [];
    let _amounts = [];


    for(let i = 0; i < resu.saleBundling.length; i++){
      _ids.push(resu.saleBundling[i].value);
      _amounts.push(resu.saleBundling[i].amount);
    }
    distribution = {};
    distribution[0] = _ids.slice();
    distribution[1] = _amounts.slice();

    let distDisplay = document.getElementById("token-dist");
    distDisplay.innerHTML = "";

    let totalation = 0;
    let aucCount = 0;
    for (i = 0; i < distribution[0].length; i++) {
      distDisplay.innerHTML += `Bundle #${i + 1}: ${
        distribution[1][i]
      } copies of a coupon for #${distribution[0][i]} tokens </br>`;
      totalation += distribution[0][i] * distribution[1][i];
      aucCount += distribution[1][i];
    }
    distDisplay.innerHTML += "</br> Total: " + totalation +" distributed out of " + saleNumber + " desired sold over " + aucCount + " separate auctions</br>"; 
    if(totalation != saleNumber) {
      distDisplay.innerHTML += "⚠️ " + (saleNumber - totalation) + " tokens could not be fitted in a bundle. ⚠️  </br>";
    }
    distDisplay.innerHTML += "</br></br>"

    /* Plot stuff */
    //let plot = Plot.rectY({length: 10000}, Plot.binX({y: "count"}, {x: Math.random})).plot();

    let _plotData = [];
    for(let i = 0; i < resu.saleBundling.length; i++){
      _ids.push(resu.saleBundling[i].value);
      _amounts.push(resu.saleBundling[i].amount);

      _plotData.push({"bundleSize":resu.saleBundling[i].value, "shareOfTokens":(((resu.saleBundling[i].amount * resu.saleBundling[i].value)/saleNumber))})
    }
    let plot = Plot.plot({
      width: 960,
      height: 500,
      y: {percent: true},
      marks: [
        Plot.barY(_plotData, {x: "bundleSize", y: "shareOfTokens", fill: "steelblue"}),
        Plot.ruleY([0])
      ]
    })
    plot.id = "plotted";
    if(document.querySelector("#plotted") != null){
      document.querySelector("#plotted").remove();
    }
    let div = document.querySelector("#the-plot");
    div.append(plot);
    


    document.getElementById("after-generation").hidden = false;
    window.scrollTo({
      left: 0,
      top: document.body.scrollHeight,
      behavior: "smooth",
    });
  };

  creationFunctions.pageInitSpecifics();
}

function generateMetadata() {
  newMetadata = {
    name: document.getElementById("token-name").value,
    symbol: document.getElementById("token-symbol").value,
    image: document.getElementById("token-image").value,
    description: document.getElementById("token-description").value,
  };

  let displayedMetadata = newMetadata;
  displayedMetadata.symbol = undefined;
  displayedMetadata.name = "";

  document.getElementById("token-metadata").value = JSON.stringify(
    displayedMetadata,
    null,
    "\t"
  );
}

function downloadMetadataJSON() {
  var el = document.createElement("a");
  // document.body.appendChild(el);

  var data_string =
    "data:text/json;charset=utf-8," +
    encodeURIComponent(document.getElementById("token-metadata").value);
  el.setAttribute("href", data_string);
  el.setAttribute("download", "token_metadata.json");
  el.click();
}

const tokenSaleProcess = {
  deployNewTokenContract: async function () {
    const contract = new web3.eth.Contract(abis["tokenCoupon"]);

    const deployTx = contract.deploy({
      data: bytecode,
      arguments: [
        document.getElementById("token-name").value,
        document.getElementById("token-symbol").value,
        document.getElementById("token-uri").value,
        !document.getElementById("disable-transferability").checked,
        diamondAddress,
      ],
    });

    newTokenContract = await deployTx
      .send({
        from: window.ethereum.selectedAddress,
        gas: await deployTx.estimateGas(),
      })
      .once("transactionHash", (txhash) => {
        console.log(`Mining deployment transaction ...`);
        console.log(txhash);
      });
    console.log(`Contract deployed at ${newTokenContract.options.address}`);
    deploymentStatus.ERC1155.push(newTokenContract.options.address);
    localStorage.setItem("deploymentStatus", JSON.stringify(deploymentStatus));
  },
  mintBatchFromDistribution: async function (
    _distributionTokenIds,
    _distributionAmounts
  ) {
    await newTokenContract.methods
      .mintBatch(_distributionTokenIds, _distributionAmounts)
      .send({ from: window.ethereum.selectedAddress });
  },
  transferBatchToDiamond: async function (
    _distributionTokenIds,
    _distributionAmounts
  ) {
    await newTokenContract.methods
      .safeBatchTransferFrom(
        window.ethereum.selectedAddress,
        diamondAddress,
        _distributionTokenIds,
        _distributionAmounts,
        0
      )
      .send({ from: window.ethereum.selectedAddress });
  },
  startAuctionBatch: async function () {
    let startTime = Math.ceil(Date.now() / 1000) + 30;

    let selectDuration = document.getElementById("select-duration");
    let selectIncentive = document.getElementById("select-incentive");
    let minBid = document.getElementById("min-bid");

    let presetName = `${selectIncentive.getAttribute(
      "selected-value"
    )}_${selectDuration.getAttribute("selected-value")}`;
    let presetNumber = gbmPresetNames.indexOf(presetName) + 1;

    if (
      document.getElementById("start-date-selector").style.display !== "none"
    ) {
      let time = document
        .getElementsByClassName("gbm-time-picker")[0]
        .value.split(":");
      let date = document
        .getElementsByClassName("gbm-date-picker")[0]
        .value.split("-");
      startTime = Math.floor(
        new Date(
          parseInt(date[0]),
          parseInt(date[1]) - 1,
          parseInt(date[2]),
          parseInt(time[0]),
          parseInt(time[1])
        ).getTime() / 1000
      );
    }

    let finalMinBid =
      minBid.value !== "1" || minBid.value !== "" ? minBid.value : "1";

    //ToDo: Add start bid to auciton start

    //unrolling the bundles
    let tokenIDUnroll = [];
    let tokenAmountUnroll = [];
    for(let i =0; i<distribution[0].length; i++){
      for(let j = 0; j<distribution[1][i]; j++){
        tokenIDUnroll.push(distribution[0][i]);
        tokenAmountUnroll.push(1);
      }
    }

    await gbmContracts.methods
      .safeRegister1155auctionBatch(
        tokenIDUnroll,
        tokenAmountUnroll,
        deploymentStatus.ERC1155[deploymentStatus.ERC1155.length - 1],
        presetNumber,
        startTime,
        0,
        window.ethereum.selectedAddress
      )
      .send({ from: window.ethereum.selectedAddress });
  },
};

async function moveToStep(_step) {
  switch (_step) {
    case 1:
      await tokenSaleProcess.deployNewTokenContract();
      document.getElementById(
        "tokens-for-sale-header"
      ).innerHTML = `Number of ${
        document.getElementById("token-symbol").value
      } for sale`;
      break;
    case 2:
      await tokenSaleProcess.mintBatchFromDistribution(
        distribution[0], distribution[1]
      );
      await tokenSaleProcess.transferBatchToDiamond(distribution[0], distribution[1]);
      break;
    case 3:
      await tokenSaleProcess.startAuctionBatch();
      location.href = `${window.location.protocol}//${window.location.host}/auctions`;
      return;
    default:
      break;
  }
  const steps = Array.from(document.getElementsByClassName("step-container"));
  steps.forEach((_element) => _element.classList.remove("active"));
  steps[_step].classList.add("active");
  window.scrollTo({ left: 0, top: 200, behavior: "smooth" });
}

//Mapping faster than redoing the calcs
let mappingStepis = [];
for(let i = 0; i<=30; i+=3){
  let exponent = Math.floor(i/3) - 0;
  mappingStepis.push( 1.0 * (10 ** exponent));
  mappingStepis.push( 2.0 * (10 ** exponent));
  mappingStepis.push( 5.0 * (10 ** exponent));
}

function convertStepToValue(_step){
  return mappingStepis[_step];
}