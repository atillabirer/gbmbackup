<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="styles/deployment.css" />
        <link rel="stylesheet" href="styles/navbar.css" />
        <link rel="stylesheet" href="styles/metamask.css" />
        <script
        src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.6.1/web3.min.js"
        integrity="sha512-5erpERW8MxcHDF7Xea9eBQPiRtxbse70pFcaHJuOhdEBQeAxGQjUwgJbuBDWve+xP/u5IoJbKjyJk50qCnMD7A=="
        crossorigin="anonymous"
        referrerpolicy="no-referrer"
      ></script>
    </head>
    <body>
        <div class="metamask-bar">
            <div class="metamask-toggles">
                <div class="metamask-activate metamask-text">
                    <label style="margin-right: 5px;">Account: </label>
                    <div id="metamask-account">Not connected</div>
                </div>
                <!-- <div class="metamask-text">
                    <label>Diamond: </label>
                    <div class="diamond-address"></div>
                </div> -->
            </div>
            <div class="metamask-toggles"> 
                <div class="metamask-activate">
                    <div>
                        <label class="switch">
                            <input type="checkbox" id="metamask-enable">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div>
                        <img class="metamask-logo" src="./images/metamask-fox.svg" />
                    </div>
                    <div id="refresh-btn">
                        ðŸ”„
                    </div>
                </div>
                <!-- <div class="metamask-activate">
                    <div>
                        <label class="switch">
                            <input type="checkbox">;
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="environment">
                        Test Mode
                    </div>
                </div> -->
            </div>
        </div>
        <div class="nav-bar">
            <div>
                <img class="gbm-logo" src="./images/gbm-logo.svg" />
            </div>
            <div class="nav-links">
                <a class="deployment-required" hidden href="/auctions">Browse Auctions</a>
                <a class="deployment-required" hidden href="/tokens">Demo NFTs</a>
                <a class="deployment-required" hidden href="/admin">Admin Panel</a>
                <a href="/deployment">GBM Deployment</a>
            </div>
        </div>
        <h1>GBM Diamond Deployment Wizard</h1>
        <div class="deployment-container">
            <div class="column-container info-container">
                <div class="deployment-step">
                    <div class="step-counter">Step 1: Deploy DiamondCutFacet</div>
                    <div class="step-progress"></div>
                </div>
                <div class="deployment-step">
                    <div class="step-counter">Step 2: Deploy Diamond</div>
                    <div class="step-progress"></div>
                </div>
                <div class="deployment-step">
                    <div class="step-counter">Step 3: Deploy DiamondInitFacet</div>
                    <div class="step-progress"></div>
                </div>
                <div class="deployment-step">
                    <div class="step-counter">Step 4: Deploy DiamondLoupeFacet</div>
                    <div class="step-progress"></div>
                </div>
                <div class="deployment-step">
                    <div class="step-counter">Step 5: Deploy OwnershipFacet</div>
                    <div class="step-progress"></div>
                </div>
                <div class="deployment-step">
                    <div class="step-counter">Step 6: Deploy GBMAdminFacet</div>
                    <div class="step-progress"></div>
                </div>
                <div class="deployment-step">
                    <div class="step-counter">Step 7: Deploy GBMAuctionBiddingFacet</div>
                    <div class="step-progress"></div>
                </div>
                <div class="deployment-step">
                    <div class="step-counter">Step 8: Deploy GBMCurrencyFacet</div>
                    <div class="step-progress"></div>
                </div>
                <div class="deployment-step">
                    <div class="step-counter">Step 9: Deploy GBMEscrowFacet_NoTracking</div>
                    <div class="step-progress"></div>
                </div>
                <div class="deployment-step">
                    <div class="step-counter">Step 10: Deploy GBMGettersFacet</div>
                    <div class="step-progress"></div>
                </div>
                <div class="deployment-step">
                    <div class="step-counter">Step 11: Deploy GBMPrimaryAuctionRegistrationFacet</div>
                    <div class="step-progress"></div>
                </div>
                <div class="deployment-step">
                    <div class="step-counter">Step 12: Cut Diamond</div>
                    <div class="step-progress"></div>
                </div>
                <div class="deployment-step">
                    <div class="step-counter">Step 13: Set GBM Presets</div>
                    <div class="step-progress"></div>
                </div>
                <div class="deployment-step">
                    <div class="step-counter">Step 14: Set Accepted Currencies</div>
                    <div class="step-progress"></div>
                </div>
                <div class="deployment-step">
                    <div class="step-counter">Step 15: Run Test Auction</div>
                    <div class="step-progress"></div>
                </div>
            </div>
            <div class="column-container terminal-container">
                <div class="terminal-text"></div>
            </div>
        </div>
        <div class="btn-container">
            <button class="deploy-btn" disabled onclick="connectToDeployer()">Please connect to Metamask!</button>
        </div>
        <script type="text/javascript" src="scripts/metamask.js"></script>
        <script type="text/javascript" src="scripts/navbar.js"></script>
        <script>
            let step = localStorage.getItem("currentDeploymentStep") ?? 0
            let diamondCutAddress = localStorage.getItem("diamondCutAddress") ?? ""
            let diamondAddress = localStorage.getItem("diamondAddress") ?? ""
            let cuts = localStorage.getItem("cuts") ?? [];
            let facets = localStorage.getItem("facets") ?? [];

            if (step >= 14) setResetState();

            function connectToDeployer() {
                localStorage.clear();
                const deployButton = document.getElementsByClassName("deploy-btn")[0];
                deployButton.classList.add('deploying');
                deployButton.disabled = true;
                deployButton.innerHTML = "Deploying..."

                const webSocket = new WebSocket('ws://localhost:443/');
                
                webSocket.onopen = (event) => {
                    webSocket.send(`PRE-DEPLOYMENT || ${window.ethereum.selectedAddress}`);
                }

                webSocket.onmessage = (event) => {
                    let deployOrder = ["DCF", "DD", "FT", "FT", "FT", "FT", "FT", "FT", "FT", "FT", "FT", "CUT", "PRST", "CRC", "TST"]
                    
                    let receivedMsg = event.data;
                    let commands = receivedMsg.split(" || ");
                    if (commands[0] !== 'SERVER') return;

                    switch (commands[1]) {
                        case 'MSG': 
                            let msgToDisplay = `${new Date().toLocaleTimeString()} - ${commands[2]}`;
                            document.getElementsByClassName('terminal-text')[0].innerHTML += msgToDisplay + '<br/>';
                            break;
                        case 'TST':
                            document.getElementsByClassName('terminal-text')[0].innerHTML += 'All done!<br/>';
                            step++;
                            saveDeployerStatus(commands);
                            updateProgress();
                            deployButton.innerHTML = "Deployment complete!"
                            setResetState();
                            webSocket.send(`POST-DEPLOYMENT || ${window.ethereum.selectedAddress} || ${localStorage.getItem('metamaskNonce') ?? '0'}`)
                            localStorage.removeItem("metamaskNonce");
                            flipVisibility();
                            webSocket.close();
                            break;
                        default: 
                            step++;
                            localStorage.setItem("currentDeploymentStep", step);
                            saveDeployerStatus(commands);
                            updateProgress();
                        case 'ACK':
                            webSocket.send(`CLIENT || ${deployOrder[step]} || ${step} || ${diamondCutAddress} || ${diamondAddress} || ${cuts} || ${facets}`);
                    }
                };
            }

            function saveDeployerStatus(commands) {
                switch(commands[1]) {
                    case "DCF": 
                        localStorage.setItem("diamondCutAddress", commands[2]);
                        diamondCutAddress = commands[2];
                        break;
                    case "DD": 
                        localStorage.setItem("diamondAddress", commands[2]);
                        diamondAddress = commands[2];
                        break;
                    case "FT": 
                        localStorage.setItem("cuts", commands[2]);
                        cuts = commands[2];
                        localStorage.setItem("facets", commands[3]);
                        facets = commands[3];
                        break;
                    case "TST":
                        localStorage.setItem("erc721contract", commands[2]);
                    default:
                        break;
                }
            }

            function updateProgress() { 
                const stepProgressContainers = document.getElementsByClassName("step-progress");
                if (step < 15) stepProgressContainers[step].innerHTML = `<div class="lds-ellipsis"><div></div><div></div><div></div><div></div></div>`;
                if (step > 0) stepProgressContainers[step - 1].innerHTML = `Done!`;
            }
         
            function setResetState() {
                const deployButton = document.getElementsByClassName("deploy-btn")[0];
                deployButton.innerHTML = "Deployed! - Click again for a hard reset"
                deployButton.style.backgroundColor = 'limegreen';
                deployButton.style.border = 'none';
                deployButton.style.cursor = 'pointer';
                deployButton.onclick = initReset;
            }

            function initReset() {
                localStorage.clear();
                window.location.reload();
            }
         </script>
    </body>
</html>